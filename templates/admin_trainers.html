{# templates/admin_trainers.html #}
{% extends "base_admin.html" %}
{% block content %}

<h1>Formateurs</h1>

<div class="card">
  <h2>Créer un formateur</h2>

  <form method="post" action="{{ url_for('admin_trainers_create') }}">
    <div class="grid">
      <label>Nom*<input name="last_name" required></label>
      <label>Prénom*<input name="first_name" required></label>
      <label>Code intervenant (min 4)*<input name="access_code" required minlength="4" placeholder="ex: 4821"></label>
    </div>

    <div class="sig-card" style="margin-top:12px;">
      <h3>Signature intervenant (obligatoire)</h3>
      <canvas id="trainerSigCanvas" class="sig-canvas"></canvas>
      <div class="sig-actions">
        <button class="btn secondary" id="clearTrainerSig" type="button">Effacer</button>
      </div>
      <input type="hidden" name="signature_dataurl" id="signature_dataurl">
      <small>Signer à la souris/stylet, puis cliquer sur “Créer”.</small>
    </div>

    <div style="margin-top:12px;">
      <button class="btn primary" type="submit">Créer</button>
    </div>
  </form>
</div>

<hr>

<div class="card">
  <h2>Liste des formateurs</h2>

  {% if trainers|length == 0 %}
    <p>Aucun formateur.</p>
  {% else %}
    <table class="table">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Prénom</th>
          <th>Actif</th>
          <th>Code (remplacement)</th>
          <th>Signature (remplacement PNG)</th>
          <th>Signature actuelle</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for t in trainers %}
        <tr>
          <form method="post" action="{{ url_for('admin_trainers_update', trainer_id=t.id) }}" enctype="multipart/form-data">
            <td><input name="last_name" value="{{ t.last_name }}" required></td>
            <td><input name="first_name" value="{{ t.first_name }}" required></td>

            <td style="text-align:center;">
              <input type="checkbox" name="is_active" {% if t.is_active %}checked{% endif %}>
            </td>

            <td>
              <input name="access_code" minlength="4" placeholder="(laisser vide = inchangé)">
              <small>Min 4 caractères</small>
            </td>

            <td>
              <input type="file" name="signature_file" accept="image/png">
              <small>PNG uniquement</small>
            </td>

            <td>
              {% if t.signature_path %}
                <a class="btn small" href="{{ url_for('get_file', relpath=t.signature_path) }}" target="_blank">Voir</a>
              {% else %}
                <em>—</em>
              {% endif %}
            </td>

            <td class="actions-col">
              <button class="btn" type="submit">Enregistrer</button>
          </form>

              <form method="post" action="{{ url_for('admin_trainers_delete', trainer_id=t.id) }}" style="display:inline;">
                <button class="btn danger" type="submit" onclick="return confirm('Supprimer ce formateur ?');">Supprimer</button>
              </form>
            </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endif %}
</div>

<script>
(function(){
  function setup(canvasId, hiddenId, clearBtnId){
    const canvas = document.getElementById(canvasId);
    const hidden = document.getElementById(hiddenId);
    if(!canvas || !hidden) return;

    const ctx = canvas.getContext("2d");
    let drawing = false;

    function resize(){
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#111";
      ctx.clearRect(0, 0, rect.width, rect.height);
    }

    function pos(evt){
      const rect = canvas.getBoundingClientRect();
      const clientX = evt.touches ? evt.touches[0].clientX : evt.clientX;
      const clientY = evt.touches ? evt.touches[0].clientY : evt.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    function start(e){
      e.preventDefault();
      drawing = true;
      const p = pos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    }

    function move(e){
      if(!drawing) return;
      e.preventDefault();
      const p = pos(e);
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
    }

    function end(e){
      if(!drawing) return;
      e.preventDefault();
      drawing = false;
    }

    function updateHidden(){
      hidden.value = canvas.toDataURL("image/png");
    }

    resize();
    window.addEventListener("resize", resize);

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", move);
    window.addEventListener("mouseup", end);

    canvas.addEventListener("touchstart", start, {passive:false});
    canvas.addEventListener("touchmove", move, {passive:false});
    canvas.addEventListener("touchend", end, {passive:false});

    const clearBtn = document.getElementById(clearBtnId);
    if(clearBtn){
      clearBtn.addEventListener("click", (e) => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        ctx.clearRect(0, 0, rect.width, rect.height);
        hidden.value = "";
      });
    }

    const form = canvas.closest("form");
    if(form){
      form.addEventListener("submit", () => updateHidden());
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    setup("trainerSigCanvas", "signature_dataurl", "clearTrainerSig");
  });
})();
</script>

{% endblock %}
