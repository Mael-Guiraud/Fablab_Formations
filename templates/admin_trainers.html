{# templates/admin_trainers.html #}
{% extends "base_admin.html" %}
{% set title="Formateurs" %}
{% block content %}

<div class="card">
  <h2>Créer un formateur</h2>

  <form method="post" action="{{ url_for('admin_trainers_create') }}">
    <div class="grid">
      <label>Nom*
        <input name="last_name" required>
      </label>

      <label>Prénom*
        <input name="first_name" required>
      </label>

      <label>Code intervenant (min 4)*
        <input type="password"
               name="access_code"
               required
               minlength="4"
               autocomplete="new-password"
               placeholder="ex: 4821">
      </label>
    </div>

    <div class="sig-card" style="margin-top:12px;">
      <div class="text-title">Signature intervenant</div>
      <canvas id="createSigCanvas" class="sig-canvas"></canvas>
      <div class="sig-actions">
        <button class="btn secondary" id="clearCreateSig" type="button">Effacer</button>
      </div>
      <input type="hidden" name="signature_dataurl" id="create_signature_dataurl">
      <small>Signer à la souris/stylet puis cliquer sur “Créer”.</small>
    </div>

    <button type="submit">Créer</button>
  </form>
</div>

<div class="card">
  <h2>Liste</h2>

  <table class="table trainers-table">
    <thead>
      <tr>
        <th>Nom</th>
        <th>Prénom</th>
        <th style="width:110px;">Actif</th>
        <th style="width:260px;">Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for t in trainers %}
      <form method="post" action="{{ url_for('admin_trainers_update', trainer_id=t.id) }}">
        <!-- Ligne 1 : infos principales -->
        <tr class="row-main">
          <td>
            <input name="last_name" value="{{ t.last_name }}" required style="width:100%;">
          </td>

          <td>
            <input name="first_name" value="{{ t.first_name }}" required style="width:100%;">
          </td>

          <td style="text-align:center;">
            <label class="switch">
              <input type="checkbox" name="is_active" {% if t.is_active %}checked{% endif %}>
              <span class="switch-label">{{ "Oui" if t.is_active else "Non" }}</span>
            </label>
          </td>

          <td class="actions-col">
            <button type="submit">Mettre à jour</button>

            <form method="post"
                  action="{{ url_for('admin_trainers_delete', trainer_id=t.id) }}"
                  onsubmit="return confirm('Supprimer ce formateur ?');"
                  style="display:inline;">
              <button type="submit" class="danger">Supprimer</button>
            </form>
          </td>
        </tr>

        <!-- Ligne 2 : code + signature (ce que tu veux vraiment) -->
        <tr class="row-tools">
          <td colspan="4">
            <div class="tools-grid">

              <div class="tool-block">
                <div class="text-title">Nouveau code (laisser vide = inchangé)</div>
                <input type="password"
                       name="access_code"
                       minlength="4"
                       autocomplete="new-password"
                       placeholder="Nouveau code">
                <small>Min 4 caractères.</small>
              </div>

              <div class="tool-block">
  <div class="text-title">Signature actuelle</div>

  {% if t.signature_path %}
    <img class="sig-thumb"
         src="{{ url_for('admin_trainer_signature', trainer_id=t.id) }}"
         alt="Signature actuelle">
  {% else %}
    <em>Aucune signature enregistrée</em>
  {% endif %}

  <div class="text-title" style="margin-top:10px;">
    Nouvelle signature (laisser vide = inchangé)
  </div>

  <canvas id="sig_{{ t.id }}" class="sig-canvas small"></canvas>

  <div class="sig-actions">
    <button type="button"
            class="btn secondary"
            id="clear_{{ t.id }}">
      Effacer
    </button>
  </div>

  <input type="hidden"
         name="signature_dataurl"
         id="sigdata_{{ t.id }}">
</div>


            </div>
          </td>
        </tr>
      </form>
      {% endfor %}
    </tbody>
  </table>
</div>

<style>
.trainers-table .row-main td{ vertical-align: middle; }
.trainers-table .row-tools td{ background:#fafafa; }

.tools-grid{
  display: grid;
  grid-template-columns: 1fr 1.2fr;
  gap: 18px;
  padding: 10px 2px;
  align-items: start;
}

.tool-block small{ color:#555; }

.text-title{ font-weight: 700; margin-bottom: 6px; }

.switch{ display:inline-flex; align-items:center; gap:8px; }
.switch-label{ font-size:0.9em; color:#444; }

.actions-col{ white-space: nowrap; }
.actions-col button{ margin-right: 6px; }

.sig-canvas{
  width: 100%;
  height: 160px;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 8px;
}

.sig-canvas.small{ height: 140px; }
</style>

<script>
(function(){
  function setupPad(canvasId, hiddenId, clearBtnId){
    const canvas = document.getElementById(canvasId);
    const hidden = document.getElementById(hiddenId);
    const clearBtn = document.getElementById(clearBtnId);
    if(!canvas || !hidden || !clearBtn) return;

    const ctx = canvas.getContext("2d");
    let drawing = false;

    function resize(){
      const r = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.round(r.width * dpr);
      canvas.height = Math.round(r.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.lineWidth = 2;
      ctx.lineCap = "round";
      ctx.strokeStyle = "#111";
      ctx.clearRect(0,0,r.width,r.height);
    }

    function pos(e){
      const r = canvas.getBoundingClientRect();
      const x = (e.touches?e.touches[0].clientX:e.clientX) - r.left;
      const y = (e.touches?e.touches[0].clientY:e.clientY) - r.top;
      return {x,y};
    }

    function start(e){
      e.preventDefault();
      drawing = true;
      const p = pos(e);
      ctx.beginPath();
      ctx.moveTo(p.x,p.y);
    }

    function move(e){
      if(!drawing) return;
      e.preventDefault();
      const p = pos(e);
      ctx.lineTo(p.x,p.y);
      ctx.stroke();
    }

    function end(e){
      if(!drawing) return;
      e.preventDefault();
      drawing = false;
    }

    canvas.addEventListener("mousedown", start);
    canvas.addEventListener("mousemove", move);
    window.addEventListener("mouseup", end);

    canvas.addEventListener("touchstart", start, {passive:false});
    canvas.addEventListener("touchmove", move, {passive:false});
    canvas.addEventListener("touchend", end, {passive:false});

    clearBtn.addEventListener("click", (e)=>{
      e.preventDefault();
      const r = canvas.getBoundingClientRect();
      ctx.clearRect(0,0,r.width,r.height);
      hidden.value = "";
    });

    const form = canvas.closest("form");
    if(form){
      form.addEventListener("submit", ()=>{
        hidden.value = canvas.toDataURL("image/png");
      });
    }

    resize();
    window.addEventListener("resize", resize);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    setupPad("createSigCanvas", "create_signature_dataurl", "clearCreateSig");
    {% for t in trainers %}
      setupPad("sig_{{ t.id }}", "sigdata_{{ t.id }}", "clear_{{ t.id }}");
    {% endfor %}
  });
})();
</script>

{% endblock %}
